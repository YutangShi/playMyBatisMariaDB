<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="services.WebService">

	<!-- 註冊會員 -->
	<insert id="signupNewMember" parameterType="pojo.web.signup.request.SignupRequest">
		insert into
		member_main (memberNo ,email , password , username , createDate, modifyDate)
		values
		( 
			null , 
			#{signupRequest.email} ,
			#{signupRequest.password},
			#{signupRequest.username} ,
			DATE_FORMAT(NOW() , '%Y%m%d%H%i%s') ,
			DATE_FORMAT(NOW(),'%Y%m%d%H%i%s')
		);
	</insert>


	<!-- 檢查是否有重覆註冊的會員 -->
	<select id="checkMemberByEmail" parameterType="String"
		resultType="boolean">
		SELECT count(1) FROM member_main WHERE email=#{email}
	</select>
	

	<!-- 根據email查詢會員資料 -->
	<select id="findMemberByEmail" parameterType="String"
		resultType="pojo.web.Member">
		SELECT * FROM member_main WHERE email = #{email}
	</select>


	<!-- 註冊認證連結 -->
	<insert id="genSignupAuthData" parameterType="Map">
		insert into
		member_auth (authString ,memberNo , sendDate , isUse , createDate , modifyDate , expiryDate)
		values
		( 
			#{memberAuth.authString} , 
			#{memberAuth.memberNo} ,
			DATE_FORMAT(NOW() , '%Y%m%d%H%i%s'),
			0,
			DATE_FORMAT(NOW() , '%Y%m%d%H%i%s') ,
			DATE_FORMAT(NOW(),'%Y%m%d%H%i%s') ,
			DATE_FORMAT(DATE_ADD(NOW(),INTERVAL 1 DAY),'%Y%m%d%H%i%s')
		);
	</insert>
	
	
	<!-- 會員記錄檔 -->
	<insert id="genMemberLoginLog" parameterType="Map">
		insert into
		member_login_log (memberNo , status , ipAddress , device , loginDate)
		values
		( 
			#{memberLoginData.memberNo} , 
			#{memberLoginData.status} ,
			#{memberLoginData.ipAddress} ,
			#{memberLoginData.device} ,
			DATE_FORMAT(NOW(),'%Y%m%d%H%i%s')
		);
	</insert>
	
	
	<!-- 撈出會員認證資訊 -->
	<select id="getSignupAuthData" parameterType="String" resultType="pojo.web.MemberAuth">
		SELECT * FROM member_auth WHERE authString=#{auth}
	</select>
	
	
</mapper>